{% comment %}
  Product Schema - Centralized

  Outputs comprehensive JSON-LD for Product type with custom properties.
  Replaces Shopify's {{ product | structured_data }} filter with enhanced version.

  Usage:
    {% render 'seo-product-schema', product: product, collection: collection %}

  Features:
    - Product entity with @id reference
    - Multiple Offer objects for variants (or AggregateOffer if many variants)
    - AggregateRating (if reviews metafield exists)
    - additionalProperty for product tags (interest, occasion, recipient, style, humour)
    - additionalProperty for personalization features (fonts, colors, message length)
    - Proper category from collection or default
{% endcomment %}

{%- comment -%} Extract category from collection or use default {%- endcomment -%}
{%- liquid
  if collection
    assign product_category = collection.title
  else
    assign product_category = 'Greeting Card'
  endif
-%}

{%- comment -%} Parse tags for structured properties {%- endcomment -%}
{%- liquid
  assign tag_interest = blank
  assign tag_occasion = blank
  assign tag_recipient = blank
  assign tag_style = blank
  assign tag_humour = blank
-%}
{%- for tag in product.tags -%}
  {%- assign tag_parts = tag | split: ':' -%}
  {%- if tag_parts.size == 2 -%}
    {%- assign tag_key = tag_parts[0] | strip -%}
    {%- assign tag_value = tag_parts[1] | strip -%}
    {%- case tag_key -%}
      {%- when 'interest' -%}
        {%- assign tag_interest = tag_value -%}
      {%- when 'occasion' -%}
        {%- assign tag_occasion = tag_value -%}
      {%- when 'recipient' -%}
        {%- assign tag_recipient = tag_value -%}
      {%- when 'style' -%}
        {%- assign tag_style = tag_value -%}
      {%- when 'humour' -%}
        {%- assign tag_humour = tag_value -%}
    {%- endcase -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Determine if we should use AggregateOffer or individual Offers {%- endcomment -%}
{%- liquid
  assign use_aggregate = false
  if product.variants.size > 3
    assign use_aggregate = true
  endif
  assign min_price = product.price_min | divided_by: 100.0
  assign max_price = product.price_max | divided_by: 100.0
-%}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ProductPage",
  "@id": "{{ shop.url }}{{ product.url }}#page",
  "url": "{{ shop.url }}{{ product.url }}",
  "mainEntity": {
    "@type": "Product",
    "@id": "{{ shop.url }}{{ product.url }}#product",
  "name": {{ product.title | json }},
  "description": {{ product.description | strip_html | truncate: 500 | json }},
  "url": "{{ shop.url }}{{ product.url }}",
  "image": [
    {%- for image in product.images limit: 8 -%}
      "{{ image.src | image_url: width: 1200 | prepend: 'https:' }}"{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ],
  "brand": {
    "@type": "Brand",
    "name": {{ shop.name | json }}
  },
  "category": {{ product_category | json }},
  "inLanguage": {{ request.locale.iso_code | json }},
  {%- if product.selected_or_first_available_variant.sku != blank -%}
  "sku": {{ product.selected_or_first_available_variant.sku | json }},
  {%- endif -%}
  {%- if use_aggregate -%}
  "offers": {
    "@type": "AggregateOffer",
    "priceCurrency": {{ cart.currency.iso_code | json }},
    "lowPrice": "{{ min_price }}",
    "highPrice": "{{ max_price }}",
    "offerCount": {{ product.variants.size }},
    "availability": "{% if product.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
    "url": "{{ shop.url }}{{ product.url }}",
    "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' }}"
  },
  {%- else -%}
  "offers": [
    {%- for variant in product.variants -%}
    {
      "@type": "Offer",
      "priceCurrency": {{ cart.currency.iso_code | json }},
      "price": "{{ variant.price | divided_by: 100.0 }}",
      "availability": "{% if variant.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
      "url": "{{ shop.url }}{{ product.url }}?variant={{ variant.id }}",
      {%- if variant.sku != blank -%}
      "sku": {{ variant.sku | json }},
      {%- endif -%}
      "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' }}"
    }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ],
  {%- endif -%}
  {%- comment -%} AggregateRating if reviews exist {%- endcomment -%}
  {%- if product.metafields.reviews.rating.value != blank -%}
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ product.metafields.reviews.rating.value }}",
    "reviewCount": "{{ product.metafields.reviews.rating_count | default: 1 }}"
  },
  {%- endif -%}
  "additionalProperty": [
    {%- comment -%} Tag-based properties {%- endcomment -%}
    {%- if tag_interest != blank -%}
    {
      "@type": "PropertyValue",
      "propertyID": "interest",
      "name": "Subject Interest",
      "value": {{ tag_interest | capitalize | json }}
    },
    {%- endif -%}
    {%- if tag_occasion != blank -%}
    {
      "@type": "PropertyValue",
      "propertyID": "occasion",
      "name": "Occasion",
      "value": {{ tag_occasion | capitalize | json }}
    },
    {%- endif -%}
    {%- if tag_recipient != blank -%}
    {
      "@type": "PropertyValue",
      "propertyID": "recipient",
      "name": "Intended Recipient",
      "value": {{ tag_recipient | capitalize | json }}
    },
    {%- endif -%}
    {%- if tag_style != blank -%}
    {
      "@type": "PropertyValue",
      "propertyID": "style",
      "name": "Visual Style",
      "value": {{ tag_style | capitalize | json }}
    },
    {%- endif -%}
    {%- if tag_humour != blank -%}
    {
      "@type": "PropertyValue",
      "propertyID": "humour",
      "name": "Humour Level",
      "value": {{ tag_humour | json }}
    },
    {%- endif -%}
    {%- comment -%} Personalization features {%- endcomment -%}
    {
      "@type": "PropertyValue",
      "propertyID": "personalization",
      "name": "Personalization Available",
      "value": "true"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "message_length",
      "name": "Maximum Message Length",
      "value": "600 characters"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "font_options",
      "name": "Font Customization",
      "value": "12 font families, 3 sizes, 6 colors"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "ai_suggestions",
      "name": "AI Message Suggestions",
      "value": "true"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "delivery_options",
      "name": "Delivery Options",
      "value": "Post to me or Send direct with envelope"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "delivery_timeframe",
      "name": "Delivery Timeframe",
      "value": "3-5 business days"
    },
    {
      "@type": "PropertyValue",
      "propertyID": "material",
      "name": "Material",
      "value": "Premium card stock"
    }
  ]
  },
  "breadcrumb": {
    "@id": "{{ shop.url }}{{ product.url }}#breadcrumbs"
  }
}
</script>
