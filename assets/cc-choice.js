/**
 * Cute Cards Choice Modal
 * Modular architecture - built from src/cc-choice/
 * Do NOT edit this file directly - edit source files instead
 * Build: 2025-11-17T18:05:36.378Z
 */
(()=>{var Ze=new URLSearchParams(window.location.search).has("debug")||window.ccDebug,et={log:(...e)=>Ze&&console.log(...e),error:(...e)=>console.error(...e)};function S(e,t={}){typeof gtag<"u"&&gtag("event",e,t),typeof window.ShopifyAnalytics<"u"&&window.ShopifyAnalytics.lib.track(e,t),et.log("[CC Analytics]",e,t)}var tt=new URLSearchParams(window.location.search).has("debug")||window.ccDebug,G={log:(...e)=>tt&&console.log(...e),warn:(...e)=>console.warn(...e),error:(...e)=>console.error(...e)},ve="cc-pers-",it=7;function se(e,t){return`${ve}${e}-${t}`}function _e(e,t,o){try{let i=se(e,t),c={data:o,timestamp:Date.now(),expiresAt:Date.now()+it*24*60*60*1e3};localStorage.setItem(i,JSON.stringify(c))}catch(i){G.warn("[CC Choice] Failed to save personalization:",i)}}function be(e,t){try{let o=se(e,t),i=localStorage.getItem(o);if(!i)return null;let c=JSON.parse(i);return Date.now()>c.expiresAt?(localStorage.removeItem(o),null):c.data}catch(o){return G.warn("[CC Choice] Failed to load personalization:",o),null}}function Q(e,t){try{let o=se(e,t);localStorage.removeItem(o)}catch(o){G.warn("[CC Choice] Failed to clear personalization:",o)}}function we(){try{let e=Date.now(),t=[];for(let o=0;o<localStorage.length;o++){let i=localStorage.key(o);if(i&&i.startsWith(ve))try{let c=localStorage.getItem(i);if(c){let n=JSON.parse(c);e>n.expiresAt&&t.push(i)}}catch{t.push(i)}}t.forEach(o=>localStorage.removeItem(o)),t.length>0&&G.log(`[CC Choice] Cleared ${t.length} expired personalizations`)}catch(e){G.warn("[CC Choice] Failed to clear expired personalizations:",e)}}function Ce({dialogWidth:e,dialogHeight:t,headerHeight:o,modalPadding:i,columnGap:c,cardAspect:n}){let a=e-i*2,s=t-i*2-o,d=(a-c)*.7,u=(a-c)*.3,p=d,f=p/n,m=420,b=s-60;return f>b&&(f=b,p=f*n),f<m&&(f=Math.min(m,b),p=f*n),{cardWidth:Math.floor(p),cardHeight:Math.floor(f),previewColumnWidth:Math.floor(d),controlsColumnWidth:Math.floor(u),availableHeight:s,needsScroll:f<m}}function Se(e,t,o){if(!t||!e||!o)return;e.style.setProperty("--ccc-card-width",`${t.cardWidth}px`),e.style.setProperty("--ccc-card-height",`${t.cardHeight}px`);let i=o.querySelector(".ccc__personaliser");i&&(i.setAttribute("data-ccc-layout-mode","desktop"),t.needsScroll&&i.setAttribute("data-ccc-scroll-mode","enabled"))}function ke(e){let t=getComputedStyle(e);return{headerHeight:parseInt(t.getPropertyValue("--ccc-header-height"))||110,modalPadding:parseInt(t.getPropertyValue("--ccc-modal-padding"))||24,columnGap:parseInt(t.getPropertyValue("--ccc-column-gap"))||32,cardAspect:parseFloat(t.getPropertyValue("--ccc-card-aspect"))||1.43}}function Le(){return`
    <div class="ccc__loading">
      <div class="ccc__spinner" role="status" aria-live="polite">
        <svg class="ccc__spinner-svg" viewBox="0 0 50 50">
          <circle class="ccc__spinner-circle" cx="25" cy="25" r="20" fill="none" stroke-width="4"></circle>
        </svg>
        <span class="visually-hidden">Loading product options...</span>
      </div>
    </div>
  `}function E(e){return`\xA3${(e/100).toFixed(2)}`}var xe=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0,A={log:(...e)=>xe&&console.log(...e),warn:(...e)=>xe&&console.warn(...e),error:(...e)=>console.error(...e)},ot=30*60*1e3;async function Ee(e){if(window.prodigiVariantSkus&&window.prodigiVariantSkus[e])return A.log("[CC Choice] Using Liquid-injected metafield data for:",e),A.log("[CC Choice] Injected SKU data:",window.prodigiVariantSkus[e]),window.prodigiVariantSkus[e];let t=`prodigi_skus_${e}`,o=sessionStorage.getItem(t);if(o)try{let i=JSON.parse(o);if(Date.now()-i.timestamp<ot)return A.log("[CC Choice] Using cached metafield data for:",e),i.data}catch(i){A.warn("[CC Choice] Invalid metafield cache:",i)}try{A.log("[CC Choice] Fetching metafields via Storefront API for:",e);let i=`
      {
        product(handle: "${e}") {
          variants(first: 20) {
            edges {
              node {
                id
                sku_bla: metafield(namespace: "custom", key: "sku_bla") {
                  value
                }
                sku_dir: metafield(namespace: "custom", key: "sku_dir") {
                  value
                }
              }
            }
          }
        }
      }
    `,c=await fetch("/api/2024-10/graphql.json",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:i})});if(!c.ok)throw new Error(`Storefront API error: ${c.status}`);let n=await c.json();if(A.log("[CC Choice] Storefront API response:",n),n.errors)return A.error("[CC Choice] GraphQL errors:",n.errors),null;let a={},s=n.data?.product?.variants?.edges||[];A.log("[CC Choice] Found variants:",s.length),s.forEach(u=>{let p=u.node,f=p.id.split("/").pop();a[f]={sku_bla:p.sku_bla?.value||null,sku_dir:p.sku_dir?.value||null},A.log(`[CC Choice] Variant ${f}:`,{sku_bla:p.sku_bla?.value,sku_dir:p.sku_dir?.value})}),A.log("[CC Choice] Final SKU map:",a);let d={data:a,timestamp:Date.now()};return sessionStorage.setItem(t,JSON.stringify(d)),a}catch(i){return A.error("[CC Choice] Failed to fetch variant metafields:",i),null}}function Ae(e,t){return!e||!t?null:e[t]||null}var ct="https://cute-cards-ai-suggestions.josh-715.workers.dev";var at=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0,X={log:(...e)=>at&&console.log(...e),error:(...e)=>console.error(...e)};async function Me({recipient:e,occasion:t,details:o="",imageUrl:i=""}){X.log("[AI Service] Generating suggestions for:",{recipient:e,occasion:t,details:o,imageUrl:i});let c=new AbortController,n=setTimeout(()=>c.abort(),3e4);try{let a=await fetch(ct,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({recipient:e.trim(),occasion:t.trim(),details:o.trim(),imageUrl:i}),signal:c.signal});if(clearTimeout(n),!a.ok){let d=await a.text().catch(()=>"Unknown error");throw new Error(`AI worker returned ${a.status}: ${d}`)}let s=await a.json();if(s.error)throw new Error(s.error);if(!s.suggestions||s.suggestions.length===0)throw new Error("No suggestions returned from AI");return X.log("[AI Service] Successfully generated suggestions:",s.suggestions.length),s}catch(a){throw clearTimeout(n),a.name==="AbortError"?(X.error("[AI Service] Request timed out after",3e4,"ms"),new Error("Request timed out. Please try again.")):(X.error("[AI Service] Failed to generate suggestions:",a),a)}}var Pe=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0,H={log:(...e)=>Pe&&console.log(...e),warn:(...e)=>Pe&&console.warn(...e),error:(...e)=>console.error(...e)};function j(){let e=["Playfair+Display","Dancing+Script","Pacifico","Great+Vibes","Caveat","Permanent+Marker","Shadows+Into+Light","Cookie","Satisfy","Indie+Flower","Lora","Crimson+Text"],t=document.createElement("link");return t.rel="stylesheet",t.href=`https://fonts.googleapis.com/css2?family=${e.join(":wght@400;600&family=")}:wght@400;600&display=swap`,document.head.appendChild(t),H.log("[Message Field] Loading all Google Fonts for inline editing"),document.fonts.ready}function Te(e){let t=e.querySelector("[data-ccc-canvas]"),o=e.querySelector("[data-ccc-canvas-placeholder]");if(!t){H.error("[Message Field] Canvas not found");return}let c=t.parentElement.clientWidth,n=2.8/2;t.width=1400,t.height=1e3,t.style.width="100%",t.style.height="auto",H.log("[Message Field] Canvas initialized:",{width:t.width,height:t.height}),j().then(()=>{ne(e,"","Playfair Display","medium","#1A1A1A")})}function ne(e,t,o="Playfair Display",i="medium",c="#1A1A1A"){let n=e.querySelector("[data-ccc-canvas]"),a=e.querySelector("[data-ccc-canvas-placeholder]");if(!n)return;let s=n.getContext("2d"),d=n.width,u=n.height;if(t.trim().length===0){a&&a.removeAttribute("hidden"),n.style.opacity="0";return}else a&&a.setAttribute("hidden",""),n.style.opacity="1";s.clearRect(0,0,d,u),s.fillStyle="#FAF9F6",s.fillRect(0,0,d,u);for(let k=0;k<1e3;k++){let x=Math.random()*d,z=Math.random()*u,te=Math.random()*.015;s.fillStyle=`rgba(0, 0, 0, ${te})`,s.fillRect(x,z,1,1)}s.strokeStyle="rgba(0, 0, 0, 0.08)",s.lineWidth=2,s.setLineDash([10,5]),s.beginPath(),s.moveTo(d/2,0),s.lineTo(d/2,u),s.stroke(),s.setLineDash([]);let p=d/2,f=d/2,m=80;s.fillStyle=c,s.textAlign="center",s.textBaseline="middle";let C={small:24,medium:32,large:42}[i]||32;s.font=`${C}px "${o}", Georgia, 'Times New Roman', serif`;let N=f-m*2,T=C*1.5,W=t.split(" "),M=[],L="";W.forEach(k=>{let x=L+(L?" ":"")+k;s.measureText(x).width>N&&L!==""?(M.push(L),L=k):L=x}),L&&M.push(L);let h=M.length*T,I=u-m*2;h>I&&H.warn("[Message Field] Text too tall for card:",{totalTextHeight:h,maxHeight:I,lines:M.length});let R=M.length*T,$=(u-R)/2+T/2,B=p+f*.45;H.log("[Message Field] Text position:",{canvasWidth:d,rightPageX:p,rightPageWidth:f,centerX:B,calculation:`${p} + (${f} * 0.45) = ${B}`}),M.forEach((k,x)=>{let z=$+x*T;s.fillText(k,B,z)}),H.log("[Message Field] Canvas rendered:",{messageLength:t.length,lines:M.length,fontFamily:o,fontSize:C,fitsVertically:h<=I})}function st(){let e=document.createElement("div");return e.className="ccc__confirm-dialog",e.hidden=!0,e.innerHTML=`
    <div class="ccc__confirm-backdrop"></div>
    <div class="ccc__confirm-panel">
      <div class="ccc__confirm-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      </div>
      <h3 class="ccc__confirm-title">Clear your message?</h3>
      <p class="ccc__confirm-message">This will permanently delete your message. This action cannot be undone.</p>
      <div class="ccc__confirm-actions">
        <button type="button" class="ccc__confirm-btn ccc__confirm-btn--cancel">Cancel</button>
        <button type="button" class="ccc__confirm-btn ccc__confirm-btn--confirm">Clear message</button>
      </div>
    </div>
  `,document.body.appendChild(e),e}function De(e,t){return new Promise(o=>{let i=document.querySelector(".ccc__confirm-dialog");i||(i=st());let c=i.querySelector(".ccc__confirm-title"),n=i.querySelector(".ccc__confirm-message");e&&(c.textContent=e),t&&(n.textContent=t);let a=i.querySelector(".ccc__confirm-btn--cancel"),s=i.querySelector(".ccc__confirm-btn--confirm"),d=i.querySelector(".ccc__confirm-backdrop");i.hidden=!1,setTimeout(()=>s.focus(),100);let u=()=>{m(),o(!1)},p=()=>{m(),o(!0)},f=b=>{b.key==="Escape"?u():b.key==="Enter"&&document.activeElement===s&&p()},m=()=>{i.hidden=!0,a.removeEventListener("click",u),s.removeEventListener("click",p),d.removeEventListener("click",u),document.removeEventListener("keydown",f)};a.addEventListener("click",u),s.addEventListener("click",p),d.addEventListener("click",u),document.addEventListener("keydown",f)})}function F(e){if(!e)return"";let t=document.createElement("div");return t.textContent=e,t.innerHTML}var ze=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0,_={log:(...e)=>ze&&console.log(...e),warn:(...e)=>ze&&console.warn(...e),error:(...e)=>console.error(...e)};function Fe({product:e,selectedVariant:t,savedPersonalization:o,formId:i,escapeHtml:c,getVariantDisplayName:n,buildRecipientAddressFields:a}){let s=o&&o.insideMessage;return`
    <div class="ccc__personaliser">
      <button type="button" class="ccc__back" data-ccc-back>
        Back to size selection
      </button>

      <div class="ccc__personaliser-header">
        <img
          src="${e.featured_image}"
          alt="${c(e.title)}"
          class="ccc__personaliser-image"
          loading="lazy"
          width="200"
          height="200"
        >
        <div class="ccc__personaliser-info">
          <h2 class="ccc__personaliser-title">${c(e.title)}</h2>
          <p class="ccc__personaliser-variant">
            ${n(t)} \u2022 ${E(t.price)}
          </p>
        </div>
      </div>

      ${s?`
        <div class="ccc__restore-prompt" data-ccc-restore-prompt data-saved-inside="${c(o.insideMessage||"")}">
          <div class="ccc__restore-content">
            <svg class="ccc__restore-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 8.53565 17.5716 7.16959 16.8284 6.02513" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M14 6L17 3L20 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="ccc__restore-text">
              <strong>Continue where you left off?</strong>
              <p>We saved your previous personalization</p>
            </div>
          </div>
          <div class="ccc__restore-actions">
            <button type="button" class="button button--small" data-ccc-restore>Restore</button>
            <button type="button" class="button button--small button--secondary" data-ccc-dismiss>Start fresh</button>
          </div>
        </div>
      `:""}

      <!-- Left Column: Card Preview with Caption -->
      <div class="ccc__preview-column">
        <!-- Card metadata as caption -->
        <div class="ccc__card-caption">
          <img
            src="${e.featured_image}"
            alt="${c(e.title)}"
            class="ccc__card-caption-image"
            loading="lazy"
            width="48"
            height="48"
          >
          <div class="ccc__card-caption-info">
            <div class="ccc__card-caption-title">${c(e.title)}</div>
            <div class="ccc__card-caption-variant">
              ${n(t)} \u2022 ${E(t.price)}
            </div>
          </div>
        </div>

        <h3 class="ccc__card-heading">Write your message</h3>

        <div class="ccc__card-interior" data-ccc-card-interior>
          <!-- LEFT page of card interior (blank) -->
          <div class="ccc__card-page ccc__card-page--left">
          </div>

          <!-- CENTER fold line -->
          <div class="ccc__card-fold"></div>

          <!-- RIGHT page of card interior (message area) -->
          <div class="ccc__card-page ccc__card-page--right">
            <div class="ccc__writing-area" data-ccc-writing-area>
              <textarea
                class="ccc__message-field"
                data-ccc-message-field
                placeholder="Type your message here..."
                spellcheck="false"
                autocorrect="off"
                autocapitalize="off"
                data-cc-limit="600"
                style="min-height: 100px; resize: none; overflow: hidden;"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Message trim notice -->
        <div class="ccc__message-trim-notice" data-ccc-trim-notice hidden>
          <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
          </svg>
          <span>Message shortened to fit the card</span>
        </div>
      </div>

      <!-- Right Column: Unified Control Panel -->
      <div class="ccc__controls-column">
        <div class="ccc__controls-panel">
          <form id="${i}" class="ccc__form">
            <input type="hidden" name="id" value="${t.id}">

            <!-- Hidden textarea for form submission -->
            <textarea
              id="cc-inside-${i}"
              name="properties[Inside Message]"
              data-cc-inside
              style="display: none;"
            ></textarea>

            <!-- Typography Header with Clear Button -->
            <div class="ccc__typography-header">
              <h4 class="ccc__section-heading">Message style</h4>
              <button type="button" class="ccc__clear-message-btn ccc__clear-message-btn--small" data-ccc-clear-btn hidden>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
                Clear
              </button>
            </div>

            <!-- Typography Controls -->
          <div class="ccc__typography-section">
            <div class="ccc__control-row">
              <div class="ccc__control-item">
                <label class="ccc__control-label">Style</label>
                <select name="properties[Font Family]" class="ccc__font-select" data-cc-font-select>
                <option value="Playfair Display" style="font-family: 'Playfair Display', serif;">Elegant</option>
                <option value="Dancing Script" style="font-family: 'Dancing Script', cursive;">Handwritten</option>
                <option value="Pacifico" style="font-family: 'Pacifico', cursive;">Playful</option>
                <option value="Great Vibes" style="font-family: 'Great Vibes', cursive;">Fancy</option>
                <option value="Caveat" style="font-family: 'Caveat', cursive;">Casual</option>
                <option value="Permanent Marker" style="font-family: 'Permanent Marker', cursive;">Bold & Fun</option>
                <option value="Shadows Into Light" style="font-family: 'Shadows Into Light', cursive;">Friendly</option>
                <option value="Cookie" style="font-family: 'Cookie', cursive;">Whimsical</option>
                <option value="Satisfy" style="font-family: 'Satisfy', cursive;">Romantic</option>
                <option value="Indie Flower" style="font-family: 'Indie Flower', cursive;">Quirky</option>
                <option value="Lora" style="font-family: 'Lora', serif;">Traditional</option>
                <option value="Crimson Text" style="font-family: 'Crimson Text', serif;">Refined</option>
              </select>
            </div>

            <div class="ccc__control-item">
              <label class="ccc__control-label">Size</label>
              <div class="ccc__size-buttons" data-cc-size-group>
                <button type="button" class="ccc__size-btn" data-size="small">
                  <span class="ccc__size-icon" style="font-size: 18px;">A</span>
                </button>
                <button type="button" class="ccc__size-btn ccc__size-btn--active" data-size="medium">
                  <span class="ccc__size-icon" style="font-size: 24px;">A</span>
                </button>
                <button type="button" class="ccc__size-btn" data-size="large">
                  <span class="ccc__size-icon" style="font-size: 30px;">A</span>
                </button>
              </div>
              <input type="hidden" name="properties[Font Size]" value="medium" data-cc-size-input>
            </div>

            <div class="ccc__control-item">
              <label class="ccc__control-label">Colour</label>
              <div class="ccc__color-swatches" data-cc-color-group>
                <button type="button" class="ccc__color-swatch ccc__color-swatch--active" data-color="#1A1A1A" style="background: #1A1A1A;" title="Black"></button>
                <button type="button" class="ccc__color-swatch" data-color="#4A5568" style="background: #4A5568;" title="Dark Grey"></button>
                <button type="button" class="ccc__color-swatch" data-color="#2563EB" style="background: #2563EB;" title="Blue"></button>
                <button type="button" class="ccc__color-swatch" data-color="#DC2626" style="background: #DC2626;" title="Red"></button>
                <button type="button" class="ccc__color-swatch" data-color="#059669" style="background: #059669;" title="Green"></button>
                <button type="button" class="ccc__color-swatch" data-color="#7C3AED" style="background: #7C3AED;" title="Purple"></button>
              </div>
              <input type="hidden" name="properties[Text Color]" value="#1A1A1A" data-cc-color-input>
            </div>
          </div>
        </div>

            <!-- Leave Blank Toggle -->
            <label class="ccc__leave-blank">
              <input type="checkbox" data-cc-leave-blank>
              <span class="ccc__leave-blank-label">Leave blank (send without message)</span>
            </label>

            <!-- AI Help Section - after controls, collapsible -->
            <div class="ccc__ai-help-section">
              <button type="button" class="ccc__ai-help-toggle" data-ccc-ai-toggle aria-expanded="false">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                  <path d="M2 17L12 22L22 17"/>
                  <path d="M2 12L12 17L22 12"/>
                </svg>
                Need message ideas?
              </button>
              <p class="ccc__ai-help-description">We'll suggest a few ideas \u2013 you can tweak them.</p>

              <div class="ccc__ai-help-panel ccc__ai-help-panel--collapsed" data-ccc-ai-panel>
                <div class="ccc__ai-form" data-ccc-ai-form>
                  <p class="ccc__ai-description">Let AI help you craft the perfect message</p>

                  <div class="ccc__ai-inputs">
                    <input
                      type="text"
                      placeholder="Recipient name (e.g., Mum, Sarah)"
                      data-ai-recipient
                      class="ccc__ai-input"
                    >
                    <select data-ai-occasion class="ccc__ai-input">
                      <option value="">Select occasion...</option>
                      <option value="birthday">Birthday</option>
                      <option value="thank-you">Thank you</option>
                      <option value="congratulations">Congratulations</option>
                      <option value="get-well">Get well soon</option>
                      <option value="sympathy">Sympathy</option>
                      <option value="love">Love & Romance</option>
                      <option value="friendship">Friendship</option>
                      <option value="just-because">Just because</option>
                    </select>
                    <textarea
                      placeholder="Any specific details? (optional)"
                      data-ai-details
                      class="ccc__ai-input ccc__ai-textarea"
                      rows="2"
                    ></textarea>
                  </div>

                  <button type="button" class="button button--secondary" data-ccc-ai-generate>
                    Get message ideas
                  </button>
                </div>

                <div class="ccc__ai-results" data-ccc-ai-results hidden>
                  <!-- Results populated by JS -->
                </div>

                <div class="ccc__ai-used" data-ccc-ai-used hidden>
                  <p>\u2728 You've used AI suggestions for this card</p>
                </div>
              </div>
            </div>

            <!-- Hidden Fields -->
            <input type="hidden" name="properties[_card_template]" value="classic-5x7">
            <input type="hidden" name="properties[_artwork_prompt]" value="">
            <input type="hidden" name="properties[_prodigi_sku]" data-ccc-prodigi-sku value="">
            <input type="hidden" name="properties[Delivery Method]" data-ccc-delivery-method value="Mail2Me">

            <!-- Error Container -->
            <div class="cc-error" role="alert" aria-live="assertive" hidden data-cc-error></div>

            <!-- Recipient address fields (shown when "Send direct" selected from footer) -->
            <div class="ccc__recipient-fields" data-ccc-recipient-fields hidden>
              <h4 class="ccc__section-heading">Recipient Address</h4>
              ${a()}
            </div>
          </form>
        </div>
      </div>

      <!-- Sticky Footer Bar (Desktop + Mobile) - Single CTA zone -->
      <div class="ccc__sticky-footer ccc__sticky-footer--personalise">
        <!-- Left: Delivery selection -->
        <div class="ccc__footer-delivery">
          <div class="ccc__footer-delivery-toggle">
            <button type="button" class="ccc__delivery-toggle-btn ccc__delivery-toggle-btn--active" data-footer-delivery="Mail2Me">
              Post to me
            </button>
            <button type="button" class="ccc__delivery-toggle-btn" data-footer-delivery="Mail4Me">
              Send direct
            </button>
          </div>
          <span class="ccc__footer-delivery-summary" data-ccc-footer-summary">Sent to you with blank envelope</span>
        </div>

        <!-- Right: Yellow CTA -->
        <button type="submit" form="${i}" class="ccc__footer-cta">
          Add to basket \xB7 ${E(t.price)}
        </button>
      </div>
    </div>
  `}function Ie(e,t,o){let{product:i,selectedVariantId:c,variantSkuMap:n}=t,a=null,s=null,d=null,u=e.querySelector("[data-cc-inside]"),p=e.querySelector("[data-cc-inside-counter]"),f=e.querySelector("[data-ccc-back]");f&&f.addEventListener("click",()=>o.onBack());let m=e.querySelector("[data-ccc-restore-prompt]");if(m){let r=m.querySelector("[data-ccc-restore]"),l=m.querySelector("[data-ccc-dismiss]");r&&r.addEventListener("click",()=>{u&&(u.value=m.dataset.savedInside||"",p&&(p.textContent=`${u.value.length}/600`)),m.style.animation="restorePromptFadeOut 0.3s var(--ease-out-quart) forwards",setTimeout(()=>m.remove(),300)}),l&&l.addEventListener("click",()=>{Q(i.handle,c),m.style.animation="restorePromptFadeOut 0.3s var(--ease-out-quart) forwards",setTimeout(()=>m.remove(),300)})}let b=e.querySelector("[data-ccc-recipient-fields]"),C=e.querySelector("[data-ccc-prodigi-sku]"),N=e.querySelector("[data-ccc-delivery-method]"),T=Ae(n,c),W=e.querySelectorAll("[data-footer-delivery]"),M=e.querySelector("[data-ccc-footer-summary]"),L=r=>{let l=r==="Mail4Me";N&&(N.value=r),C&&T&&(C.value=l?T.sku_dir:T.sku_bla),b&&(l?(b.hidden=!1,b.style.animation="recipientFieldsFadeIn 0.4s var(--ease-out-expo) forwards"):b.hidden=!0),W.forEach(g=>{g.dataset.footerDelivery===r?g.classList.add("ccc__delivery-toggle-btn--active"):g.classList.remove("ccc__delivery-toggle-btn--active")}),M&&(M.textContent=l?"We'll post it directly for you":"Sent to you with blank envelope"),S("cc_delivery_method_changed",{product_handle:i.handle,delivery_method:r}),_.log("[CC Choice] Delivery method changed:",{deliveryMethod:r,sku:C?.value})};W.forEach(r=>{r.addEventListener("click",()=>{L(r.dataset.footerDelivery)})}),L("Mail2Me");let h=e.querySelector("[data-ccc-message-field]"),I=e.querySelector("[data-cc-inside]"),R=e.querySelector("[data-cc-font-select]"),ee=e.querySelectorAll("[data-size]"),$=e.querySelector("[data-cc-size-input]"),B=e.querySelectorAll("[data-color]"),k=e.querySelector("[data-cc-color-input]"),x=()=>{if(!h)return;let r=R?R.value:"Playfair Display",l=$?$.value:"medium",g=k?k.value:"#1A1A1A",w={small:"1.4rem",medium:"1.8rem",large:"2.2rem"};h.style.setProperty("font-family",`"${r}", Georgia, serif`,"important"),h.style.setProperty("font-size",w[l]||"1.8rem","important"),h.style.setProperty("color",g,"important"),_.log("[CC Choice] Field style updated:",{fontFamily:r,fontSize:l,textColor:g})},z="",te=()=>{!h||!I||(I.value=h.value)};if(h){let r=h.closest(".ccc__card-page--right"),l=()=>{let v=r?r.clientHeight-24:320;h.style.height="auto";let P=h.scrollHeight,ae=!1;if(P<=v)h.style.height=P+"px",z=h.value;else{let Y=h.value;for(;P>v&&Y.length>0;)Y=Y.slice(0,-1),h.value=Y,h.style.height="auto",P=h.scrollHeight,ae=!0;h.style.height=P+"px",z=h.value}return ae},g=e.querySelector("[data-ccc-trim-notice]"),w;if(h.addEventListener("input",()=>{let v=l();te(),v&&g&&(g.hidden=!1,clearTimeout(w),w=setTimeout(()=>{g.hidden=!0},4e3))}),h.addEventListener("keydown",v=>{if(v.key==="Enter"){let P=r?r.clientHeight-24:320;h.scrollHeight+20>P&&v.preventDefault()}}),r&&typeof ResizeObserver<"u"){let v=new ResizeObserver(()=>{clearTimeout(s),s=setTimeout(()=>{l()},100)});v.observe(r),d=v}a=l,l(),setTimeout(()=>h.focus(),100)}let O=e.querySelector("[data-ccc-clear-btn]");if(O&&h){let r=()=>{h.value.trim().length>0?O.hidden=!1:O.hidden=!0};h.addEventListener("input",r),O.addEventListener("click",async()=>{if(await De("Clear your message?","This will permanently delete your message. This action cannot be undone.")){h.value="";let g=new Event("input",{bubbles:!0});h.dispatchEvent(g),O.hidden=!0,h.focus(),S("cc_message_cleared",{product_handle:i.handle,variant_id:c})}}),r()}R&&R.addEventListener("change",()=>{x(),a&&setTimeout(()=>a(),100)}),ee.forEach(r=>{r.addEventListener("click",()=>{ee.forEach(l=>l.classList.remove("ccc__size-btn--active")),r.classList.add("ccc__size-btn--active"),$&&($.value=r.dataset.size),x(),a&&setTimeout(()=>a(),100)})}),B.forEach(r=>{r.addEventListener("click",()=>{B.forEach(l=>l.classList.remove("ccc__color-swatch--active")),r.classList.add("ccc__color-swatch--active"),k&&(k.value=r.dataset.color),_.log("[CC Choice] Color changed to:",r.dataset.color),x()})}),j().then(()=>{x(),h&&a&&setTimeout(()=>a(),50)});let K=e.querySelector("[data-ccc-ai-toggle]"),ie=e.querySelector("[data-ccc-ai-panel]"),Qe=e.querySelector("[data-ccc-ai-form]"),J=e.querySelector("[data-ccc-ai-results]"),vt=e.querySelector("[data-ccc-ai-used]"),V=e.querySelector("[data-ccc-ai-generate]"),oe=e.querySelector("[data-ai-recipient]"),ce=e.querySelector("[data-ai-occasion]"),ge=e.querySelector("[data-ai-details]"),_t=`ai_used_${i.handle}_${c}`;if(K&&ie){let r=K.cloneNode(!0);K.parentNode.replaceChild(r,K),r.addEventListener("click",()=>{let l=r.getAttribute("aria-expanded")==="true";r.setAttribute("aria-expanded",!l),ie.classList.toggle("ccc__ai-help-panel--collapsed",l),l||(setTimeout(()=>{ie.scrollIntoView({behavior:"smooth",block:"nearest"})},50),S("cc_ai_form_open",{product_handle:i.handle,variant_id:c}))})}V&&V.addEventListener("click",async()=>{if(!oe||!oe.value.trim()){alert("Please enter the recipient's name");return}if(!ce||!ce.value){alert("Please select an occasion");return}V.disabled=!0,V.textContent="Generating...";try{let r=await Me({recipient:oe.value,occasion:ce.value,details:ge?ge.value:"",imageUrl:i.featured_image||""});r.suggestions&&r.suggestions.length>0&&(J.innerHTML=r.suggestions.map((l,g)=>`
              <div class="ccc__ai-suggestion-card">
                <p class="ccc__ai-suggestion-text">${F(l.message)}</p>
                <div class="ccc__ai-suggestion-actions">
                  <button type="button" class="ccc__ai-use-btn" data-ai-use="${g}">
                    Use this
                  </button>
                  <button type="button" class="ccc__ai-copy-btn" data-ai-copy="${g}">
                    Copy
                  </button>
                </div>
              </div>
            `).join(""),J.removeAttribute("hidden"),Qe.setAttribute("hidden",""),J.querySelectorAll("[data-ai-use]").forEach(l=>{l.addEventListener("click",()=>{let g=parseInt(l.dataset.aiUse),w=r.suggestions[g];if(h){h.value=w.message;let v=new Event("input",{bubbles:!0});h.dispatchEvent(v),setTimeout(()=>h.focus(),50),setTimeout(()=>{let P=e.querySelector('[role="dialog"]');P&&P.scrollTo({top:0,behavior:"smooth"})},100)}S("cc_ai_suggestion_use",{product_handle:i.handle,variant_id:c,suggestion_index:g})})}),J.querySelectorAll("[data-ai-copy]").forEach(l=>{l.addEventListener("click",async()=>{let g=parseInt(l.dataset.aiCopy),w=r.suggestions[g];try{await navigator.clipboard.writeText(w.message),l.textContent="Copied!",setTimeout(()=>{l.textContent="Copy"},2e3),S("cc_ai_suggestion_copy",{product_handle:i.handle,variant_id:c,suggestion_index:g})}catch(v){_.error("Failed to copy:",v)}})}),S("cc_ai_suggestions_generated",{product_handle:i.handle,variant_id:c,count:r.suggestions.length}))}catch(r){_.error("[CC Choice] AI generation error:",r),alert("Sorry, we couldn't generate suggestions right now. Please try again.")}finally{V.disabled=!1,V.textContent="Generate Suggestions"}});let me,Xe=()=>{clearTimeout(me),me=setTimeout(()=>{let r={insideMessage:u?u.value:""};_e(i.handle,c,r)},500)};u&&u.addEventListener("input",Xe);let ye=e.querySelector("[data-cc-leave-blank]");ye&&u&&ye.addEventListener("change",r=>{let l=e.querySelector("[data-ccc-message-field]"),g=e.querySelector("[data-ccc-writing-area]"),w=e.querySelector(".ccc__typography-section"),v=e.querySelector("[data-ccc-ai-toggle]");r.target.checked?(u.disabled=!0,u.required=!1,u.value="",l&&(l.value="",l.disabled=!0,l.classList.add("ccc__message-field--blank"),l.setAttribute("tabindex","-1")),g&&g.classList.add("ccc__writing-area--blank"),w&&w.classList.add("ccc__typography-section--disabled"),v&&(v.disabled=!0,v.style.opacity="0.4")):(u.disabled=!1,u.required=!0,l&&(l.disabled=!1,l.classList.remove("ccc__message-field--blank"),l.removeAttribute("tabindex"),l.focus()),g&&g.classList.remove("ccc__writing-area--blank"),w&&w.classList.remove("ccc__typography-section--disabled"),v&&(v.disabled=!1,v.style.opacity=""))}),setTimeout(()=>{let r=e.querySelector("[data-ccc-message-field]"),l=e.querySelector("[data-cc-leave-blank]");r&&(!l||!l.checked)&&r.focus()},150);let q=e.querySelector("#cc-modal-form");if(_.log("[CC Choice] Looking for form #cc-modal-form..."),q)_.log("[CC Choice] Form found immediately, Form ID:",q?.id),qe(e,q,o);else{_.log("[CC Choice] Form not found on first attempt, retrying...");let r=0,l=3,g=setInterval(()=>{q=e.querySelector("#cc-modal-form"),r++,q||r>=l?(clearInterval(g),q?(_.log(`[CC Choice] Form found after ${r} retry(ies)`),qe(e,q,o)):(_.error("[CC Choice] CRITICAL: Form #cc-modal-form not found after retries!"),_.error("[CC Choice] Modal body HTML (first 500 chars):",e.querySelector("[data-ccc-body]").innerHTML.substring(0,500)),_.error("[CC Choice] Available forms:",e.querySelectorAll("form").length),e.querySelectorAll("form").forEach(w=>{_.error("[CC Choice] Found form with ID:",w.id||"no ID")}))):_.log(`[CC Choice] Retry ${r}/${l}...`)},100)}}function qe(e,t,o){_.log("[Personaliser View] Attaching submit event listener to form"),t.addEventListener("submit",c=>{_.log("[Personaliser View] Form submit event fired"),_.log("[Personaliser View] Event target:",c.target),_.log("[Personaliser View] Form element:",t),_.log("[Personaliser View] Submit button:",c.submitter),c.preventDefault(),o.onSubmit(t)});let i=t.querySelectorAll('[type="submit"]');_.log("[Personaliser View] Submit buttons found in form:",i.length),i.forEach((c,n)=>{_.log(`[Personaliser View] Submit button ${n+1}:`,c.textContent.trim())})}var D=new Map,nt=10;async function Re(e){if(D.has(e)){let i=D.get(e);return D.delete(e),D.set(e,i),i}let t=await fetch(`/products/${e}.js`);if(!t.ok)throw new Error(`Product not found: ${e}`);let o=await t.json();if(D.size>=nt){let i=D.keys().next().value;D.delete(i)}return D.set(e,o),o}var rt=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0,$e={log:(...e)=>rt&&console.log(...e),error:(...e)=>console.error(...e)};async function re(e){$e.log("[Cart Service] Adding to cart with payload:",e);let t=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),o=await t.json();if(!t.ok)throw new Error(o.description||"Could not add to cart");return $e.log("[Cart Service] Successfully added to cart:",o),o}var lt=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0,Be={log:(...e)=>lt&&console.log(...e),error:(...e)=>console.error(...e)};function le(e){if(!e)return;let t=document.createElement("div");t.className="ccc__success-banner",t.innerHTML=`
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
    <span>Added to basket!</span>
  `,e.insertBefore(t,e.firstChild),requestAnimationFrame(()=>{t.style.animation="successSlideDown 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards"})}function de(e){e&&(e.disabled=!0,e.classList.add("button--success"),e.innerHTML=`
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
    <span>Added!</span>
  `)}async function ue(){let e=document.querySelector("cart-drawer");if(e)try{await(await fetch("/cart.js")).json(),typeof e.renderContents=="function"&&e.renderContents(),typeof e.open=="function"&&e.open()}catch(t){Be.error("[Cart Drawer] Failed to refresh cart:",t),typeof e.open=="function"&&e.open()}else Be.log("[Cart Drawer] No cart drawer found, redirecting to /cart"),window.location.href="/cart"}var Ve=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0,U={log:(...e)=>Ve&&console.log(...e),warn:(...e)=>Ve&&console.warn(...e)};function dt(e){if(!e.options||e.options.length===0)return 0;let t=e.options.findIndex(o=>typeof o!="string"?!1:o.toLowerCase().includes("size")||o.toLowerCase().includes("card size"));return t>=0?t:0}function ut(e){let t=e.toLowerCase();return t.includes("large")||t.includes("big")?"Most Popular":t.includes("giant")||t.includes("xl")?"Makes a Statement":t.includes("standard")||t.includes("medium")?"Perfect Size":t.includes("small")||t.includes("compact")?"Sweet & Simple":""}function pt(e){let t=e.toLowerCase(),o={standard:'132 \xD7 185mm (5.2" \xD7 7.3")',large:'205 \xD7 290mm (8.1" \xD7 11.4")',giant:'293 \xD7 419mm (11.5" \xD7 16.5")',small:'105 \xD7 148mm (4.1" \xD7 5.8")',a5:'148 \xD7 210mm (5.8" \xD7 8.3")',a4:'210 \xD7 297mm (8.3" \xD7 11.7")',a6:'105 \xD7 148mm (4.1" \xD7 5.8")'};for(let[i,c]of Object.entries(o))if(t.includes(i))return c;return""}function ht(e){let t=e.toLowerCase(),o={standard:"Classic card size \u2013 fits perfectly on the mantelpiece",large:"Big impact \u2013 guaranteed to stand out",giant:"Statement piece \u2013 impossible to miss",small:"Cute and compact \u2013 perfect for desks",a5:"Generous space for longer messages",a4:"Maximum canvas \u2013 for when you have lots to say",a6:"Sweet little card \u2013 big on charm",square:"Modern and bold \u2013 looks great anywhere"};for(let[i,c]of Object.entries(o))if(t.includes(i))return c;return""}function ft(e,t,o){U.log("[Choice View] Building size radios:",{totalVariants:t.length,sizeOptionIndex:o,productOptions:e.options,variants:t.map(a=>({id:a.id,title:a.title,options:a.options,available:a.available}))});let i={};t.forEach(a=>{let s=a.options[o];U.log(`[Choice View] Variant ${a.id} has size: "${s}"`),i[s]||(i[s]=a)}),U.log("[Choice View] Variants grouped by size:",i);let c="",n=!0;return Object.entries(i).forEach(([a,s])=>{let d=a.toLowerCase()==="default title"||a.toLowerCase()==="default";if(d&&Object.keys(i).length>1)return;let u=ut(a),p=pt(a),f=ht(a),m=d?"Standard":a;c+=`
      <label class="ccc__size-option">
        <input
          type="radio"
          name="variant"
          value="${s.id}"
          data-price="${s.price}"
          data-size-name="${F(m)}"
          ${n?"checked":""}
          ${s.available?"":"disabled"}
        >
        <div class="ccc__size-content">
          <div class="ccc__size-header">
            <span class="ccc__size-label">${F(m)}</span>
            ${u?`<span class="ccc__size-badge">${u}</span>`:""}
          </div>
          ${p?`<span class="ccc__size-dimensions">${p}</span>`:""}
          ${f?`<p class="ccc__size-personality">${f}</p>`:""}
          <span class="ccc__size-price">${E(s.price)}</span>
        </div>
        ${s.available?"":'<span class="ccc__size-unavailable">Out of stock</span>'}
      </label>
    `,n=!1}),c}function He({product:e,selectedVariantId:t}){U.log("[Choice View] Rendering choice view for:",e.handle);let o=dt(e),i=e.variants;if(U.log("[Choice View] Using all variants (POD model):",i),U.log("[Choice View] Total variants:",i.length),i.length===0)return'<div class="ccc__error">Sorry, this product is currently out of stock.</div>';let c=i[0];return`
    <div class="ccc__choice">
      <div class="ccc__product-preview">
        <img
          src="${e.featured_image}"
          alt="${F(e.title)}"
          class="ccc__product-image"
          loading="eager"
          style="aspect-ratio: 1 / 1; width: 100%;"
          width="600"
          height="600"
        >
        <h2 id="ccc-title" class="ccc__product-title">${F(e.title)}</h2>
        <div class="ccc__product-price">
          <span data-ccc-price aria-live="polite" aria-atomic="true">${E(c.price)}</span>
        </div>
      </div>

      <div class="ccc__options">
        <div class="ccc__progress-strip" aria-label="Shopping steps">
          <span class="ccc__progress-step ccc__progress-step--active">
            <span class="ccc__progress-dot"></span>
            Choose size
          </span>
          <span class="ccc__progress-separator">\xB7</span>
          <span class="ccc__progress-step">
            <span class="ccc__progress-dot"></span>
            Personalise
          </span>
          <span class="ccc__progress-separator">\xB7</span>
          <span class="ccc__progress-step">
            <span class="ccc__progress-dot"></span>
            Add to cart
          </span>
        </div>

        <h3 id="ccc-sizes-heading" class="ccc__sizes-heading">Select size</h3>
        <fieldset class="ccc__sizes" aria-labelledby="ccc-sizes-heading" role="radiogroup">
          ${ft(e,i,o)}
        </fieldset>

        <div class="ccc__delivery-promise">
          <svg class="ccc__delivery-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M14 9.5V4.5C14 4.22386 13.7761 4 13.5 4H10.5L9 2H4.5C4.22386 2 4 2.22386 4 2.5V9.5M14 9.5H4M14 9.5L15.5 14H0.5L2 9.5H4M4 9.5V2.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Printed today, on their doorstep in a couple of days</span>
        </div>

        <div class="ccc__actions">
          <button class="button button--primary" data-ccc-personalise data-ccc-price="${c.price}">
            Personalise \u2014 ${E(c.price)}
          </button>
          <p class="ccc__actions-caption">You'll see exactly how it looks inside before you buy</p>
          <button class="button button--secondary" data-ccc-add-blank>
            Add blank
          </button>
        </div>

        <!-- Recommendation Rail Container -->
        <div id="cc-recs-container"></div>

        <a href="${e.url}" class="ccc__more-info" target="_blank">
          <span>More information</span>
          <svg class="ccc__more-info-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M6 3L11 8L6 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </div>
    </div>
  `}function Ue(e,t){let o=e.querySelector("[data-ccc-personalise]"),i=e.querySelectorAll('input[name="variant"]');i.forEach(n=>{n.addEventListener("change",a=>{let s=parseInt(a.target.value,10),d=parseInt(a.target.dataset.price,10),u=a.target.dataset.sizeName||"",p=e.querySelector("[data-ccc-price]");p&&(p.style.animation="none",setTimeout(()=>{p.textContent=E(d),p.style.animation="priceChange 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)"},10)),o&&(o.textContent=`Personalise \u2014 ${E(d)}`,o.dataset.cccPrice=d),t.onVariantChange&&t.onVariantChange(s,d,u)})}),i.forEach((n,a)=>{n.addEventListener("keydown",s=>{let d=a;if(s.key==="ArrowDown"||s.key==="ArrowRight")s.preventDefault(),d=(a+1)%i.length;else if(s.key==="ArrowUp"||s.key==="ArrowLeft")s.preventDefault(),d=(a-1+i.length)%i.length;else return;i[d].focus(),i[d].checked=!0,i[d].dispatchEvent(new Event("change",{bubbles:!0}))})}),o&&o.addEventListener("click",()=>{t.onPersonalise&&t.onPersonalise()});let c=e.querySelector("[data-ccc-add-blank]");c&&c.addEventListener("click",()=>{t.onAddBlank&&t.onAddBlank()})}function Oe(e,t){let o=e.querySelector(".ccc__footer-mobile");o&&o.remove();let i=`
    <div class="ccc__footer-mobile">
      <button class="button button--primary" data-ccc-personalise-mobile data-ccc-price="${t.price}">
        Personalise \u2014 ${E(t.price)}
      </button>
    </div>
  `;e.insertAdjacentHTML("beforeend",i);let c=e.querySelector("[data-ccc-personalise-mobile]");c&&e._choiceViewCallbacks&&e._choiceViewCallbacks.onPersonalise&&c.addEventListener("click",()=>{e._choiceViewCallbacks.onPersonalise()})}var Wt=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0;var gt=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0,mt={warn:(...e)=>gt&&console.warn(...e)};function Ge(e){if(typeof window.ccRecs>"u"){mt.warn("[Recs Integration] Recommendation engine not loaded");return}if(!e||!e.tags)return;let t=Array.isArray(e.tags)?e.tags:(e.tags||"").split(",").map(c=>c.trim()),o={interest:[],occasion:[],recipient:[],style:[],humour:[]};t.forEach(c=>{let a=c.toLowerCase().trim().split(":");if(a.length===2){let[s,d]=a;o.hasOwnProperty(s)&&o[s].push(d)}});let i=window.ccRecs.createRail("#cc-recs-container");i&&i.render(e.handle,o)}var je=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0,y={log:(...e)=>je&&console.log(...e),warn:(...e)=>je&&console.warn(...e),error:(...e)=>console.error(...e)};function pe(e,t){e&&(e.textContent=t,e.hidden=!1)}function yt(e){e&&(e.textContent="",e.hidden=!0)}var he=class extends HTMLElement{constructor(){super(),this.productData=null,this.selectedVariantId=null,this.variantSkuMap=null,this.opener=null,this._cachedLayout=null,this._resizeObserver=null,this._resizeDebounce=null}connectedCallback(){this.modalElement=this,this.dialog=this.querySelector("[data-ccc-dialog]"),this.backdrop=this.querySelector("[data-ccc-backdrop]"),this.body=this.querySelector("[data-ccc-body]"),this.errorElement=this.querySelector("[data-ccc-error]"),this.bindCloseHandlers()}bindCloseHandlers(){let t=this.querySelector("[data-ccc-close]");t&&t.addEventListener("click",()=>this.hide()),this.backdrop&&this.backdrop.addEventListener("click",o=>{o.target===this.backdrop&&this.hide()})}async show({handle:t,productUrl:o,opener:i=null,fromRecs:c=!1}){y.log("[CC Choice] show() called with:",{handle:t,productUrl:o,opener:i,fromRecs:c}),this.opener=i,yt(this.errorElement),this.body.innerHTML=Le(),this.modalElement.hidden=!1,this.modalElement.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden",S("cc_modal_open",{product_handle:t,source:c?"recommendations":"grid"}),this.pushHistoryState(t);try{this.productData=await Re(t),y.log("[CC Choice] Product data loaded:",this.productData),this.variantSkuMap=await this.loadVariantSkus(),this.buildChoiceView()}catch(n){console.error("[CC Choice] Failed to load product:",n),pe(this.errorElement,"Unable to load product details. Please try again.")}}hide(){y.log("[CC Choice] hide() called"),this.modalElement.hidden=!0,this.modalElement.setAttribute("aria-hidden","true"),document.body.style.overflow="",this.body.innerHTML="",this.opener&&this.opener.focus&&this.opener.focus(),window.history.state&&window.history.state.ccModal&&window.history.replaceState(null,"",window.location.pathname),S("cc_modal_close",{product_handle:this.productData?.handle}),this.productData=null,this.selectedVariantId=null,this.variantSkuMap=null,this.opener=null}pushHistoryState(t){let o=`/products/${t}`;(!window.history.state||!window.history.state.ccModal)&&window.history.pushState({ccModal:!0,handle:t},"",o)}async loadVariantSkus(){try{let t=await Ee(this.productData.handle);if(t&&Object.keys(t).length>0)return y.log("[CC Choice] Loaded variant SKUs from metafields:",t),t}catch(t){y.warn("[CC Choice] Metafield fetch failed:",t)}return y.warn("[CC Choice] No SKU map found for product:",this.productData.handle),{}}buildChoiceView(){y.log("[CC Choice] buildChoiceView()");let t=this.productData,o=t.variants,i=this.selectedVariantId;!i&&o.length>0&&(i=o[0].id);let c=He({product:t,selectedVariantId:i});this.body.innerHTML=c,Ge(t),requestAnimationFrame(()=>{Ue(this,{onVariantChange:n=>{this.selectedVariantId=n,y.log("[CC Choice] Variant changed to:",n)},onPersonalise:()=>{y.log("[CC Choice] Personalise button clicked"),this.buildPersonaliserView()},onAddBlank:n=>{y.log("[CC Choice] Add blank clicked for variant:",n),this.handleBlankAdd(n)}}),Oe(this),this.updateLayout(),this.setupResizeListener()})}buildPersonaliserView(){y.log("[CC Choice] buildPersonaliserView()");let t=this.productData,o=t.variants.find(n=>n.id===this.selectedVariantId);if(!o){console.error("[CC Choice] No variant selected!");return}S("cc_personalise_open",{product_id:t.id,variant_id:o.id,price:o.price});let i=be(t.handle,o.id),c=Fe(t,o,i);this.body.innerHTML=c,requestAnimationFrame(()=>{Ie(this,{product:this.productData,selectedVariantId:this.selectedVariantId,variantSkuMap:this.variantSkuMap},{onBack:()=>this.buildChoiceView(),onSubmit:n=>this.handlePersonalisedAdd(n)}),this.updateLayout(),this.setupResizeListener(),j(),Te(this)})}async handleBlankAdd(t){y.log("[CC Choice] handleBlankAdd() for variant:",t);let o=this.productData.variants.find(n=>n.id===t);if(!o){console.error("[CC Choice] Variant not found:",t);return}let i={id:o.id,quantity:1,properties:{leave_blank:"Yes","Delivery Method":"Mail2Me"}},c=this.querySelector("[data-ccc-add-blank]");try{await re(i),S("cc_add_blank_success",{product_id:this.productData.id,variant_id:o.id,price:o.price}),c&&de(c),le(this.dialog),setTimeout(()=>{ue(),this.hide()},800)}catch(n){console.error("[CC Choice] Add to cart failed:",n),pe(this.errorElement,"Unable to add to cart. Please try again.")}}async handlePersonalisedAdd(t){y.log("[CC Choice] handlePersonalisedAdd()"),y.log("[CC Choice] Form element:",t),y.log("[CC Choice] Form ID:",t?.id),y.log("[CC Choice] Form action:",t?.action);let o=this.productData.variants.find(C=>C.id===this.selectedVariantId);if(!o){console.error("[CC Choice] No variant selected!");return}let i=new FormData(t),c=i.get("insideMessage")||"",n=i.get("fontFamily")||"Playfair Display",a=i.get("fontSize")||"medium",s=i.get("textColor")||"#1A1A1A",d=i.get("deliveryMethod")||"Mail2Me",u=i.get("leave_blank")==="on";y.log("[CC Choice] Form data extracted:",{insideMessage:c.substring(0,50)+"...",fontFamily:n,fontSize:a,textColor:s,deliveryMethod:d,leaveBlank:u});let p={"Inside Message":u?"":c,"Font Family":n,"Font Size":a,"Text Color":s,"Delivery Method":d,_card_template:"classic-5x7",_artwork_prompt:this.productData.title||""},f=this.variantSkuMap?.[this.selectedVariantId];f&&(p._prodigi_sku=f),u&&(p.leave_blank="Yes"),d==="Direct"&&(p["Recipient Name"]=i.get("recipientName")||"",p["Address Line 1"]=i.get("addressLine1")||"",p["Address Line 2"]=i.get("addressLine2")||"",p.City=i.get("city")||"",p.Postcode=i.get("postcode")||"",p.Country=i.get("country")||"United Kingdom"),y.log("[CC Choice] Cart properties:",p);let m={id:o.id,quantity:1,properties:p},b=t.querySelector('[type="submit"]');y.log("[CC Choice] Submit button found:",b),y.log("[CC Choice] Submit button text:",b?.textContent);try{y.log("[CC Choice] Calling addToCart with payload:",m),await re(m),S("cc_add_personalised_success",{product_id:this.productData.id,variant_id:o.id,price:o.price,has_message:!u&&c.length>0,message_length:c.length,delivery_method:d}),b&&(y.log("[CC Choice] Transforming button to success state"),de(b)),le(this.dialog),Q(this.productData.handle,o.id),setTimeout(()=>{y.log("[CC Choice] Opening cart drawer and hiding modal"),ue(),this.hide()},800)}catch(C){console.error("[CC Choice] Add to cart failed:",C),y.error("[CC Choice] Error details:",C.message,C.stack),pe(this.errorElement,"Unable to add to cart. Please try again."),b&&(b.disabled=!1,b.classList.remove("button--loading"))}}updateLayout(){let t=ke(this);if(!t)return;let o=Ce(t);Se(this,o),this._cachedLayout={config:t,layout:o}}setupResizeListener(){this._resizeObserver&&this._resizeObserver.disconnect(),this._resizeObserver=new ResizeObserver(()=>{clearTimeout(this._resizeDebounce),this._resizeDebounce=setTimeout(()=>{this.updateLayout()},100)}),this.dialog&&this._resizeObserver.observe(this.dialog)}renderCardPreview(t,o="Playfair Display",i="medium",c="#1A1A1A"){ne(this,t,o,i,c)}},Ne=he;var We=new URLSearchParams(window.location.search).has("cc_debug")||window.ccDebug===!0,Z={log:(...e)=>We&&console.log(...e),warn:(...e)=>We&&console.warn(...e),error:(...e)=>console.error(...e)};we();customElements.define("cc-choice-modal",Ne);function Ke(){document.addEventListener("click",e=>{if(e.ctrlKey||e.metaKey||e.shiftKey||e.button!==0)return;let t=e.target.closest("[data-cc-card]");if(!t)return;e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation();let o=document.querySelector("cc-choice-modal");if(!o){Z.error("[CC Choice] Modal not found in DOM"),window.location.href=t.href;return}let i=t.dataset.ccHandle,c=t.dataset.ccVariantSkus;if(c)try{let a=JSON.parse(c);window.prodigiVariantSkus=window.prodigiVariantSkus||{},window.prodigiVariantSkus[i]=a,Z.log("[CC Choice] Loaded SKU data from card element for:",i,a)}catch(a){Z.error("[CC Choice] Failed to parse variant SKUs from card element:",a)}else Z.log("[CC Choice] No variant SKU data on card element for:",i);let n=t.closest(".cc-recs")!==null;o.show({handle:i,productUrl:t.href,opener:t,fromRecs:n})},!0)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ke):Ke();var Je=new Set;function Ye(e){if(!e||Je.has(e))return;Je.add(e);let t=document.createElement("link");t.rel="prefetch",t.href=`/products/${e}.js`,t.as="fetch",document.head.appendChild(t)}function fe(){document.querySelectorAll("[data-cc-card]").forEach(t=>{let o=t.dataset.ccHandle;o&&(t.addEventListener("mouseenter",()=>{Ye(o)},{once:!0,passive:!0}),t.addEventListener("focus",()=>{Ye(o)},{once:!0,passive:!0}))})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",fe):fe();typeof window.MutationObserver<"u"&&new MutationObserver(()=>{fe()}).observe(document.body,{childList:!0,subtree:!0});window.addEventListener("popstate",e=>{let t=document.querySelector("cc-choice-modal");t&&!t.hasAttribute("hidden")&&t.hide()});})();
